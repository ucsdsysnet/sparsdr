# auto-generated by grc.converter

id: sparsdr_compressing_usrp_source
label: Compressing USRP Source
category: '[SparSDR]'
flags:
- throttle

parameters:
-   id: device_addr
    label: Device Address
    dtype: string
-   id: center_freq
    label: Center frequency
    dtype: real
-   id: gain
    label: Gain
    dtype: real

    # Choose if threshold, bin_spec, or threshold_file is used
-   id: threshold_source
    label: Threshold source
    dtype: enum
    default: 'Fixed threshold'
    options: ['Fixed threshold', 'Bin specification', 'Threshold file']
    hide: part
    
-   id: bin_spec
    label: Bin specification
    dtype: string
    default: 0..8:1
    hide: ${ 'none' if (threshold_source == 'Bin specification') else 'all' }
-   id: threshold_file
    label: Threshold file
    dtype: file_open
    hide: ${ 'none' if (threshold_source == 'Threshold file') else 'all' }
-   id: threshold
    label: Threshold
    dtype: real
    default: 1000
    hide: ${ 'none' if (threshold_source == 'Fixed threshold') else 'all' }


-   id: antenna
    label: Antenna
    dtype: string
    
-   id: skip_config
    label: Skip bin configuration
    hide: part
    dtype: bool
    default: 'False'
    options: ['False', 'True']
    option_labels: ['False', 'True']

outputs:
-   domain: stream
    dtype: sc16

templates:
    imports: |-
        import sparsdr
        from gnuradio import uhd
    make: |-
        sparsdr.compressing_usrp_source(uhd.device_addr(${device_addr}))
        self.${id}.set_center_freq(uhd.tune_request(${center_freq}))
        self.${id}.set_antenna(${antenna})
        self.${id}.set_gain(${gain})
        # Configure compression
        self.${id}.set_compression_enabled(True)
        self.${id}.stop_all()
        % if not(eval(skip_config)):
        
        % if threshold_source == "Bin specification":
        self.${id}.set_bin_spec(${bin_spec})
        % endif
        
        % if threshold_source == "Threshold file":
        self.${id}.set_thresholds_from_file(${threshold_file})
        % endif
        
        % if threshold_source == "Fixed threshold":
        # Clear masks and set threshold
        for i in range(2048):
            self.${id}.clear_bin_mask(i)
            self.${id}.set_bin_threshold(i, ${threshold})
        % endif
        
        % else:
        print('Skipping bin configuration')
        % endif
        # Start compression
        self.${id}.start_all()

file_format: 1
